name: "[DLSPS] Build, scan and test"
run-name: "[DLSPS] Build, scan and test (by @${{ github.actor }} via ${{ github.event_name }})"
on:
  workflow_call:
  workflow_dispatch:
permissions: {}
env:
  dlstreamer-version: "2025.1.2"
  DLS_REL_PATH: "./edge-ai-libraries-repo/libraries/dl-streamer"

jobs:
  build-dls-pipeline-server-image:
    name: Build DLS Pipeline Server ${{ matrix.ubuntu_version }} img
    runs-on: ubuntu-24.04-16core-64GB
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - ubuntu_version: ubuntu22
          - ubuntu_version: ubuntu24
    steps:
    - name: Check out edge-ai-libraries repository
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 #5.0.0
      with:
        persist-credentials: false
        path: edge-ai-libraries-repo

    - name: Init submodules
      run: |
        cd edge-ai-libraries-repo
        git submodule update --init libraries/dl-streamer/thirdparty/spdlog

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef #3.6.0
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build DL Streamer deb-final-img
      env:
        deb_final_img: dlstreamer-base:${{ matrix.ubuntu_version }}-${{ github.sha }}
        deb_final_img_cached: ghcr.io/${{ github.repository }}/deb-final-img-${{ matrix.ubuntu_version }}:buildcache
        dls_ubuntu22_dockefile: ${{ env.DLS_REL_PATH }}/docker/ubuntu/ubuntu22.Dockerfile
        dls_ubuntu24_dockefile: ${{ env.DLS_REL_PATH }}/docker/ubuntu/ubuntu24.Dockerfile
      run: |
        DLS_PATH="${{ env.DLS_REL_PATH }}"
        docker pull "${deb_final_img_cached}" || true
        docker buildx build \
        --load \
        --target dlstreamer \
        --tag "${deb_final_img}" \
        --cache-from="${deb_final_img_cached}" \
        --build-arg DLSTREAMER_VERSION=${{ env.dlstreamer-version }} \
        --build-arg DLSTREAMER_BUILD_NUMBER=deb-pkg-${{ matrix.ubuntu_version }} \
        -f "${DLS_PATH}/docker/ubuntu/${{ matrix.ubuntu_version }}.Dockerfile" \
        "${DLS_PATH}"
        echo "BASE_IMAGE=${deb_final_img}" >> $GITHUB_ENV

    - name: Build dls-pipeline-server-img
      run: |
        cd edge-ai-libraries-repo/microservices/dlstreamer-pipeline-server/docker
        export DLSTREAMER_PIPELINE_SERVER_IMAGE=intel/dlstreamer-pipeline-server:3.1.0-${{ matrix.ubuntu_version }}
        export DLSTREAMER_PIPELINE_SERVER_DOCKERFILE=Dockerfile
        export BUILD_TARGET=dlstreamer-pipeline-server
        docker compose build --no-cache

    - name: Build dls-pipeline-server-img-extended
      run: |
        cd edge-ai-libraries-repo/microservices/dlstreamer-pipeline-server/docker
        export DLSTREAMER_PIPELINE_SERVER_IMAGE=intel/dlstreamer-pipeline-server:3.1.0-extended-${{ matrix.ubuntu_version }}
        export DLSTREAMER_PIPELINE_SERVER_DOCKERFILE=Dockerfile
        export BUILD_TARGET=dlstreamer-pipeline-server-extended
        docker compose build --no-cache

    - name: Unit Test dls-pipeline-server
      if: matrix.ubuntu_version == 'ubuntu22'
      run: |
        cd edge-ai-libraries-repo/microservices/dlstreamer-pipeline-server/
        make build
        make test | tee /tmp/pytest_output.txt

    - name: Create Unit Test Summary
      if: matrix.ubuntu_version == 'ubuntu22'
      run: |
        pytest_output=$(cat /tmp/pytest_output.txt)
        summary_line=$(echo "$pytest_output" | grep -E '==+ .* in .*s ==+')
        echo "### Unit Test Completed for DLSPS commit id ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "### Pytest Summary" >> "$GITHUB_STEP_SUMMARY"
        echo "\`\`\`" >> "$GITHUB_STEP_SUMMARY"
        echo "$summary_line" >> "$GITHUB_STEP_SUMMARY"
        echo "\`\`\`" >> "$GITHUB_STEP_SUMMARY"

    - name: Upload unit test results to Github
      if: matrix.ubuntu_version == 'ubuntu22'
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
      with:
        name: DLSPS_Coverage-reports
        path: /tmp/htmlcov

    - name: Scan Docker image with Trivy
      uses: open-edge-platform/orch-ci/.github/actions/security/trivy@76700c2fb6d547733b9218d9638dca43f5296399 # 0.1.52
      with:
        scan_target: "intel/dlstreamer-pipeline-server:3.1.0-${{ matrix.ubuntu_version }}"
        severity: "HIGH"
        scan_type: image
        format: table
        report_suffix: "-${{ matrix.ubuntu_version }}-dlsps-img"
        scan-scope: all
        timeout: 20m
        ignore_unfixed: true

    - name: Rename Trivy report for base image
      run: |
        echo "ðŸ“ Renaming Trivy report for base image..."
        if [ -d "security-results/trivy" ]; then
          latest=$(ls -t security-results/trivy/trivy-results-*.table 2>/dev/null | head -n 1)
          if [ -n "$latest" ]; then
            mv "$latest" "security-results/trivy/trivy-base-${{ matrix.ubuntu_version }}.table"
            echo "âœ… Renamed to: trivy-base-${{ matrix.ubuntu_version }}.table"
          else
            echo "âš ï¸ No .table file found to rename"
          fi
        fi
      shell: bash

    - name: Scan Docker extended image with Trivy
      uses: open-edge-platform/orch-ci/.github/actions/security/trivy@76700c2fb6d547733b9218d9638dca43f5296399 # 0.1.52
      with:
        scan_target: "intel/dlstreamer-pipeline-server:3.1.0-extended-${{ matrix.ubuntu_version }}"
        severity: "HIGH"
        scan_type: image
        format: table
        report_suffix: "-${{ matrix.ubuntu_version }}-dlsps-extended-img"
        scan-scope: all
        timeout: 20m
        ignore_unfixed: true

    - name: Rename Trivy report for extended image
      run: |
        echo "ðŸ“ Renaming Trivy report for extended image..."
        if [ -d "security-results/trivy" ]; then
          latest=$(ls -t security-results/trivy/trivy-results-*.table 2>/dev/null | head -n 1)
          if [ -n "$latest" ]; then
            mv "$latest" "security-results/trivy/trivy-extended-${{ matrix.ubuntu_version }}.table"
            echo "âœ… Renamed to: trivy-extended-${{ matrix.ubuntu_version }}.table"
          else
            echo "âš ï¸ No .table file found to rename"
          fi
        fi
      shell: bash

    - name: Upload Trivy image report as artifact
      if: always()
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 #4.6.2
      with:
        name: DLSPS_${{ matrix.ubuntu_version }}-trivy-image-reports
        path: |
          security-results/trivy/trivy-base-${{ matrix.ubuntu_version }}.table
          security-results/trivy/trivy-extended-${{ matrix.ubuntu_version }}.table

    - name: Run Trivy Filesystem Scan
      if: matrix.ubuntu_version == 'ubuntu22'
      run: |
        docker pull aquasec/trivy:0.63.0
        cd edge-ai-libraries-repo/microservices/dlstreamer-pipeline-server/
        mkdir -p reports
        curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/html.tpl -o trivy-html.tpl

        docker run --rm -v `pwd`:/src aquasec/trivy:0.63.0 fs /src/ --format template --template "@/src/trivy-html.tpl" -o "/src/reports/trivy_fs_code_scan.html" || true
        docker run --rm -v `pwd`:/src aquasec/trivy:0.63.0 fs --list-all-pkgs --format template --template "@/src/trivy-html.tpl" --output "/src/reports/trivy-fs-full-report.csv" /src/ || true
        docker run --rm -v `pwd`:/src aquasec/trivy:0.63.0 fs --ignore-unfixed /src | tee ./reports/trivy-fs-full-report.txt
        mv ./reports ${{ github.workspace }}

    - name: Upload Trivy Filesystem Reports
      if: matrix.ubuntu_version == 'ubuntu22'
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 #4.6.2
      with:
        name: DLSPS_trivy-fs-reports
        path: reports/*

    - name: Analyze Trivy results and create summary
      if: always()
      run: |
        echo "### ðŸ” Trivy Security Scan Results for ${{ matrix.ubuntu_version }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        base_file="security-results/trivy/trivy-base-${{ matrix.ubuntu_version }}.table"
        extended_file="security-results/trivy/trivy-extended-${{ matrix.ubuntu_version }}.table"

        # Function to count vulnerabilities
        count_vulns() {
          local file=$1
          if [ -f "$file" ]; then
            awk '/â”‚/ && /Vulnerabilities/ {next} /â”‚/ {gsub(/ /, "", $0); split($0, cols, "â”‚"); print cols[4]}' "$file" | grep -v '^-$' | grep -v '^$' | head -n 1
          else
            echo "N/A"
          fi
        }

        base_vulns=$(count_vulns "$base_file")
        extended_vulns=$(count_vulns "$extended_file")

        # Base image results
        echo "#### ðŸ“¦ Base Image: \`intel/dlstreamer-pipeline-server:3.1.0-${{ matrix.ubuntu_version }}\`" >> $GITHUB_STEP_SUMMARY
        if [ -f "$base_file" ]; then
          if [ "$base_vulns" = "0" ] || [ -z "$base_vulns" ]; then
            echo "- âœ… **No HIGH vulnerabilities found**" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ **Vulnerabilities found:** $base_vulns" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "- âš ï¸ **Report not found**" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY

        # Extended image results
        echo "#### ðŸ“¦ Extended Image: \`intel/dlstreamer-pipeline-server:3.1.0-extended-${{ matrix.ubuntu_version }}\`" >> $GITHUB_STEP_SUMMARY
        if [ -f "$extended_file" ]; then
          if [ "$extended_vulns" = "0" ] || [ -z "$extended_vulns" ]; then
            echo "- âœ… **No HIGH vulnerabilities found**" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ **Vulnerabilities found:** $extended_vulns" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "- âš ï¸ **Report not found**" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY

        # Store results for final check
        echo "BASE_VULNS=$base_vulns" >> $GITHUB_ENV
        echo "EXTENDED_VULNS=$extended_vulns" >> $GITHUB_ENV
      shell: bash

    - name: Create summary
      if: always()
      run: |
        echo "### DL Streamer Pipeline Server Docker image for ${{ matrix.ubuntu_version }}" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "intel/dlstreamer-pipeline-server:3.1.0-${{ matrix.ubuntu_version }}">> $GITHUB_STEP_SUMMARY
        echo "intel/dlstreamer-pipeline-server:3.1.0-extended-${{ matrix.ubuntu_version }}" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "Built on commit id: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

    - name: Fail if vulnerabilities found
      if: always()
      run: |
        base_vulns="${BASE_VULNS:-N/A}"
        extended_vulns="${EXTENDED_VULNS:-N/A}"

        echo "ðŸ“Š Final vulnerability check:"
        echo "  Base image: $base_vulns"
        echo "  Extended image: $extended_vulns"

        if [[ "$base_vulns" != "0" && "$base_vulns" != "N/A" && -n "$base_vulns" ]] || \
           [[ "$extended_vulns" != "0" && "$extended_vulns" != "N/A" && -n "$extended_vulns" ]]; then
          echo "âŒ Vulnerabilities detected in one or more images!"
          exit 1
        else
          echo "âœ… All security scans passed!"
        fi
      shell: bash

    - name: Clean up
      if: always()
      run: |
        sudo rm -rf edge-ai-libraries-repo
        sudo rm -rf /tmp/htmlcov reports/*
        docker rmi intel/dlstreamer-pipeline-server:3.1.0-${{ matrix.ubuntu_version }} || true
        docker rmi intel/dlstreamer-pipeline-server:3.1.0-extended-${{ matrix.ubuntu_version }} || true

  dlsps-code-style:
    permissions:
      contents: read
    name: "DLSPS SCAN: code-style"
    runs-on: ubuntu-latest
    steps:
      - name: Check out edge-ai-libraries repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 #5.0.0
        with:
          persist-credentials: false

      - name: Code-style action
        uses: ./.github/actions/common/code-style
        with:
          target_dir: "microservices/dlstreamer-pipeline-server"
          name: 'DLSPS_code-style-check-report'
          fail-on-findings: true

  dlsps-check-license-headers:
    permissions:
      contents: read
    name: "DLSPS SCAN: check license headers"
    runs-on: ubuntu-latest
    steps:
    - name: Check out edge-ai-libraries repository (sparse)
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 #5.0.0
      with:
        persist-credentials: false
        sparse-checkout: |
          microservices/dlstreamer-pipeline-server
          .github
        fetch-depth: 0

    - name: Check license headers
      uses: ./.github/actions/common/license-namespace-checker
      with:
        name: 'DLSPS_license-check-report'
        path: '.'
        fail-on-findings: true

  dlsps-clamav:
    permissions:
      contents: read
    name: "DLSPS SCAN: ClamAV antivirus"
    runs-on: ubuntu-latest
    steps:
    - name: Check out edge-ai-libraries repository
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 #5.0.0
      with:
        persist-credentials: false
        path: edge-ai-libraries-repo

    - name: ClamAV scan
      id: clamav-dlsps-scan
      uses: open-edge-platform/orch-ci/.github/actions/security/clamav@76700c2fb6d547733b9218d9638dca43f5296399 # 0.1.52
      with:
        scan-scope: all
        paths: edge-ai-libraries-repo/microservices/dlstreamer-pipeline-server
        report_suffix: "DLSPS_ClamAV_antivirus_report"
        fail-on-findings: true

    - name: Analyze ClamAV results
      if: always()
      env:
        REPORT_PATH: ${{ steps.clamav-dlsps-scan.outputs.report_path }}
      run: |
        if [ -n "$REPORT_PATH" ] && [ -f "$REPORT_PATH" ]; then
          echo "ðŸ“„ Found ClamAV report: $REPORT_PATH"

          # Extract scan summary using jq
          files_scanned=$(jq -r '.scan_summary.files_scanned // 0' "$REPORT_PATH" 2>/dev/null || echo "0")
          threats_found=$(jq -r '.scan_summary.threats_found // 0' "$REPORT_PATH" 2>/dev/null || echo "0")

          echo "### ClamAV Antivirus Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“ **Files scanned**: $files_scanned" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ¦  **Threats found**: $threats_found" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$threats_found" -gt 0 ]; then
            echo "âŒ **Security Alert**: Malware or threats detected!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **Action Required**: Review the ClamAV report artifact for details." >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **All files are clean - no threats detected!**" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "### ClamAV Antivirus Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **ClamAV report not found at path: ${REPORT_PATH:-not provided}**" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Clean up
      if: always()
      run: |
        sudo rm -rf edge-ai-libraries-repo

  dlsps-bandit:
    permissions:
      contents: read
    name: "DLSPS SCAN: Bandit"
    runs-on: ubuntu-latest
    steps:
    - name: Check out edge-ai-libraries repository
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 #5.0.0
      with:
        persist-credentials: false

    - name: Run Bandit scan
      uses: open-edge-platform/orch-ci/.github/actions/security/bandit@76700c2fb6d547733b9218d9638dca43f5296399 # 0.1.52
      with:
        scan-scope: "changed"
        severity-level: "HIGH"
        confidence-level: "HIGH"
        output-format: "txt"
        paths: microservices/dlstreamer-pipeline-server
        report_suffix: dlsps
        fail-on-findings: true

  trivy-config-dockerfile-scan:
    permissions:
      contents: read
    name: "DLSPS SCAN: Trivy Dockerfile"
    strategy:
      fail-fast: false
    uses: ./.github/workflows/trivy-config-mode.yaml
    with:
      dockerfile-path: microservices/dlstreamer-pipeline-server
      trivy-report-format: 'json'
      severity-levels: 'HIGH,CRITICAL'
      output-report-path: reports/DLSPS_trivy_config_report.txt
      name: DLSPS_trivy_report

  dlsps-pylint:
    permissions:
      contents: read
      pull-requests: write
    name: "DLSPS SCAN: pylint"
    runs-on: ubuntu-latest
    steps:
      - name: Check out edge-ai-libraries repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 #5.0.0
        with:
          persist-credentials: false

      - name: Run pylint
        uses: ./.github/actions/common/pylint
        with:
          path: microservices/dlstreamer-pipeline-server
          output-file: pylint-report.txt
          name: DLSPS_pylint
          enable-reviewdog: true
          github_token: ${{ secrets.GITHUB_TOKEN }}
          fail-on-findings: true

  dlsps-shellcheck:
    permissions:
      contents: read
      pull-requests: write
    name: "DLSPS SCAN: shellcheck"
    runs-on: ubuntu-latest
    steps:
      - name: Check out edge-ai-libraries repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 #5.0.0
        with:
          path: edge-ai-libraries-repo
          persist-credentials: false
          fetch-depth: 0

      - name: Run shellcheck
        uses: ./edge-ai-libraries-repo/.github/actions/common/shellcheck
        with:
          path: edge-ai-libraries-repo/microservices/dlstreamer-pipeline-server
          output-file: shellcheck-report.txt
          name: DLSPS_shellcheck
          enable-reviewdog: true
          github_token: ${{ secrets.GITHUB_TOKEN }}
          fail-on-findings: true

      - name: Clean up
        run: |
          sudo rm -rf edge-ai-libraries-repo

  dlsps-yamllint:
    permissions:
      contents: read
      pull-requests: write
    name: "DLSPS SCAN: yamllint"
    runs-on: ubuntu-latest
    steps:
      - name: Check out edge-ai-libraries repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 #5.0.0
        with:
          path: edge-ai-libraries-repo
          persist-credentials: false

      - name: Run yamlint
        uses: ./edge-ai-libraries-repo/.github/actions/common/yamllint
        with:
          path: edge-ai-libraries-repo/microservices/dlstreamer-pipeline-server
          output-file: yamllint-report.txt
          name: DLSPS_yamlint
          enable-reviewdog: true
          github_token: ${{ secrets.GITHUB_TOKEN }}
          fail-on-findings: true

      - name: Clean up
        run: |
          sudo rm -rf edge-ai-libraries-repo

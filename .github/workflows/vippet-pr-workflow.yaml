name: "[ViPPET] PR workflow"
run-name: "[ViPPET] PR workflow (by @${{ github.actor }} via ${{ github.event_name }})"

on:
  pull_request:
    branches:
      - main
      - release-*
    paths:
      - 'tools/visual-pipeline-and-platform-evaluation-tool/**'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions: {}

jobs:
  pre-merge-pipeline:
    permissions:
      contents: read
    strategy:
      fail-fast: false
    uses: open-edge-platform/orch-ci/.github/workflows/pre-merge.yml@070a95caeeed643fc9d1a34c11eac78179ce136d  # 0.1.34
    with:
      runs_on: ubuntu-24.04
      bootstrap_tools: 'nodejs'
      run_version_check: false
      run_build: false
      run_lint: true
      lint_makeflags: '-k'
      run_test: true
      run_docker_build: true
      run_reuse_check: false
      project_folder: 'tools/visual-pipeline-and-platform-evaluation-tool'
      trivy_config_path: 'tools/visual-pipeline-and-platform-evaluation-tool/trivy.yaml'
  trivy-config-scan:
    permissions:
      contents: read
    name: SCAN Trivy ${{ matrix.name }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: vippet-app
            path: tools/visual-pipeline-and-platform-evaluation-tool/Dockerfile.vippet
            output: reports/trivy-vippet-app.json
          - name: vippet-collector
            path: tools/visual-pipeline-and-platform-evaluation-tool/collector/Dockerfile
            output: reports/trivy-vippet-collector.json
          - name: vippet-videogenerator
            path: tools/visual-pipeline-and-platform-evaluation-tool/video_generator/Dockerfile
            output: reports/trivy-vippet-videogenerator.json
    uses: ./.github/workflows/trivy-config-mode.yaml
    with:
      dockerfile-path: ${{ matrix.path }}
      trivy-config-path: 'tools/visual-pipeline-and-platform-evaluation-tool/trivy.yaml'
      trivy-report-format: 'json'
      severity-levels: 'HIGH,CRITICAL'
      output-report-path: ${{ matrix.output }}
      name: ${{ matrix.name }}
  final-check:
    permissions:
      contents: read
    runs-on: ubuntu-latest
    if: ${{ always() }}
    needs: [pre-merge-pipeline]
    steps:
      - name: Final Status Check
        env:
          pre_merge_pipeline_result: ${{ needs.pre-merge-pipeline.result }}
        run: |
          echo "Pre-merge pipeline result: $pre_merge_pipeline_result"

          if [ "$pre_merge_pipeline_result" == "success" ] || [ "$pre_merge_pipeline_result" == "skipped" ]; then
            echo "Pre-merge checks passed successfully."
          else
            echo "Pre-merge checks failed. PR can't be merged."
            exit 1
          fi

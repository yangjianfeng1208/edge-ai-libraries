FROM docker.io/library/rust:1.88 AS qmassa

RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        libudev-dev && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

RUN cargo install --git https://github.com/ulissesf/qmassa --branch new_json

FROM docker.io/library/telegraf:1.36.3 AS collector

COPY --from=qmassa /usr/local/cargo/bin/qmassa /usr/local/bin/qmassa

RUN apt-get update && \
    apt-get install -y --no-install-recommends python3 supervisor && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /app

COPY telegraf.conf /etc/telegraf
COPY qmassa_reader.py qmassa_reader.py
COPY read_cpu_freq.sh read_cpu_freq.sh
RUN chmod +x read_cpu_freq.sh

COPY supervisord.conf /etc/supervisor/conf.d/supervisord.conf

COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# nosemgrep: missing-user-entrypoint
CMD ["/entrypoint.sh"]
